<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendário de Lançamentos de Cassino</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fontes do Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script>
        // Configuração do Tailwind para usar a fonte Inter
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Estilos Customizados */
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Estilos para o efeito de partículas */
        @keyframes move {
            100% {
                transform: translate3d(0, 0, 1px) rotate(360deg);
            }
        }

        .particle {
            position: absolute;
            border-radius: 50%;
            background: rgba(129, 140, 248, 0.2); /* Tom de indigo para combinar com o tema */
            animation: move linear infinite;
            transform-origin: center center;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans">

    <!-- Efeito de Partículas no Fundo -->
    <div id="particles-js" class="absolute inset-0 z-0 overflow-hidden"></div>

    <!-- Conteúdo Principal -->
    <main class="relative z-10 max-w-7xl mx-auto p-4 md:p-8">
        <header class="flex flex-col md:flex-row justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-indigo-400 mb-4 md:mb-0">Calendário de Lançamentos</h1>
            <div class="flex items-center gap-2">
                <button id="prev-btn" class="px-4 py-2 bg-gray-700 hover:bg-indigo-500 rounded-lg transition-colors">‹‹ Anterior</button>
                <button id="today-btn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg transition-colors font-semibold">Hoje</button>
                <button id="next-btn" class="px-4 py-2 bg-gray-700 hover:bg-indigo-500 rounded-lg transition-colors">Próximo ››</button>
            </div>
        </header>

        <!-- Seção de Pesquisa -->
        <div class="mb-6 p-4 bg-gray-800 bg-opacity-50 backdrop-blur-sm rounded-lg">
            <h2 class="text-lg font-semibold mb-3">Pesquisar por Jogo:</h2>
            <div class="relative">
                <input type="text" id="search-input" placeholder="Digite o nome do jogo..." class="w-full bg-gray-700 text-white placeholder-gray-400 rounded-lg p-2 border-2 border-transparent focus:border-indigo-500 focus:ring-0 transition">
                <div id="autocomplete-list" class="absolute z-10 w-full bg-gray-700 rounded-b-lg mt-1 max-h-60 overflow-y-auto hidden"></div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="mb-6 p-4 bg-gray-800 bg-opacity-50 backdrop-blur-sm rounded-lg">
            <h2 class="text-lg font-semibold mb-3">Filtrar por Provedor:</h2>
            <div id="filters-container" class="flex flex-wrap gap-2">
                 <div class="text-gray-400">Carregando filtros...</div>
            </div>
        </div>

        <!-- Calendários -->
        <div id="calendars-container" class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="text-center md:col-span-2 text-gray-400">Carregando calendários...</div>
        </div>
    </main>

    <!-- Modal (Popup) -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4 hidden">
        <div id="modal-content" class="bg-gray-800 rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto p-6">
            <!-- Conteúdo do modal será inserido aqui via JS -->
        </div>
    </div>

    <!-- Script Principal -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- VARIÁVEIS GLOBAIS E ESTADO ---
            const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQkH5N7Zx4YSLPJyM09ny1ro1oXd3XnQSgwVg3pl0qIcneWuy9hQops8JMBuwWw_9u0xWsk3kPgHiVa/pub?gid=0&single=true&output=csv';
            const PLACEHOLDER_IMAGE = 'https://placehold.co/400x300/2A2E3B/FFFFFF?text=Sem+Imagem';
            const PLACEHOLDER_PROVIDER_IMAGE = 'https://placehold.co/100x40/374151/FFFFFF?text=Provedor';

            let events = [];
            let allProviders = [];
            let selectedProviders = ['All'];
            let searchQuery = '';
            let currentDate = new Date(2025, 0, 1); 

            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const weekDays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];

            // --- REFERÊNCIAS DO DOM ---
            const calendarsContainer = document.getElementById('calendars-container');
            const filtersContainer = document.getElementById('filters-container');
            const searchInput = document.getElementById('search-input');
            const autocompleteList = document.getElementById('autocomplete-list');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const todayBtn = document.getElementById('today-btn');
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');
            const particlesContainer = document.getElementById('particles-js');

            // --- FUNÇÕES DE RENDERIZAÇÃO ---
            
            const getFilteredEvents = () => {
                let filtered = events;

                if (!selectedProviders.includes('All')) {
                    filtered = filtered.filter(event => selectedProviders.includes(event.provider));
                }

                if (searchQuery) {
                    filtered = filtered.filter(event => event.game.toLowerCase().includes(searchQuery.toLowerCase()));
                }
                
                return filtered;
            };

            const renderFilters = () => {
                filtersContainer.innerHTML = '';
                allProviders.forEach(provider => {
                    const isSelected = selectedProviders.includes(provider);
                    const button = document.createElement('button');
                    button.textContent = provider;
                    button.className = `px-3 py-1 text-sm rounded-full transition-all duration-200 ${isSelected ? 'bg-indigo-500 text-white shadow-lg' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`;
                    button.addEventListener('click', () => handleProviderToggle(provider));
                    filtersContainer.appendChild(button);
                });
            };

            const renderCalendars = () => {
                calendarsContainer.innerHTML = '';
                const firstMonthDate = new Date(currentDate);
                const secondMonthDate = new Date(currentDate);
                secondMonthDate.setMonth(secondMonthDate.getMonth() + 1);

                const calendarData = [
                    { year: firstMonthDate.getFullYear(), month: firstMonthDate.getMonth() },
                    { year: secondMonthDate.getFullYear(), month: secondMonthDate.getMonth() },
                ];
                
                const filteredEvents = getFilteredEvents();

                calendarData.forEach(({ year, month }) => {
                    calendarsContainer.insertAdjacentHTML('beforeend', createCalendarHTML(year, month, filteredEvents));
                });
                
                document.querySelectorAll('.calendar-day').forEach(dayCell => {
                    dayCell.addEventListener('click', () => {
                        const day = parseInt(dayCell.dataset.day);
                        const month = parseInt(dayCell.dataset.month);
                        const year = parseInt(dayCell.dataset.year);
                        const clickedDate = new Date(year, month, day);

                        const dayEvents = getFilteredEvents().filter(event =>
                            event.date.getFullYear() === year &&
                            event.date.getMonth() === month &&
                            event.date.getDate() === day
                        );

                        if (dayEvents.length > 0) {
                            renderModal(clickedDate, dayEvents);
                        }
                    });
                });
            };

            const createCalendarHTML = (year, month, filteredEvents) => {
                const today = new Date();
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                let daysHTML = '';
                for (let i = 0; i < firstDayOfMonth; i++) {
                    daysHTML += `<div class="p-2"></div>`;
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const dayEvents = filteredEvents.filter(event =>
                        event.date.getFullYear() === year &&
                        event.date.getMonth() === month &&
                        event.date.getDate() === day
                    );
                    const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === day;
                    
                    const isSearched = searchQuery && dayEvents.length > 0;
                    
                    const cellClasses = `calendar-day relative p-2 rounded-lg transition-colors duration-200 aspect-square flex items-center justify-center
                        ${dayEvents.length > 0 ? 'cursor-pointer hover:bg-indigo-700 bg-gray-700' : 'text-gray-500'}
                        ${isToday ? 'bg-indigo-500 !text-white font-bold' : ''}
                        ${isSearched ? '!bg-green-500 ring-2 ring-white' : ''}`;
                    
                    daysHTML += `
                        <div class="${cellClasses}" data-day="${day}" data-month="${month}" data-year="${year}">
                            <span>${day}</span>
                            ${dayEvents.length > 0 ? `<span class="absolute top-1 right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center shadow-md">${dayEvents.length}</span>` : ''}
                        </div>`;
                }
                
                const weekDaysHTML = weekDays.map(day => `<div class="font-semibold text-xs text-gray-400">${day}</div>`).join('');

                return `
                    <div class="bg-gray-800 bg-opacity-50 backdrop-blur-sm p-4 rounded-lg shadow-2xl">
                        <h2 class="text-xl font-bold text-center mb-4 text-indigo-300">${monthNames[month]} ${year}</h2>
                        <div class="grid grid-cols-7 gap-1 text-center">
                            ${weekDaysHTML}
                            ${daysHTML}
                        </div>
                    </div>`;
            };

            const renderModal = (date, dayEvents) => {
                let eventsHTML = '';
                dayEvents.forEach(event => {
                    const certInfo = event.certificate.toLowerCase() === 'sim' 
                        ? `<div class="flex items-center gap-2 text-green-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg><span>Certificado: Sim</span></div>`
                        : `<div class="flex items-center gap-2 text-red-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg><span>Certificado: Não</span></div>`;

                    eventsHTML += `
                        <div class="bg-gray-700 p-4 rounded-lg flex flex-col md:flex-row gap-4 items-start">
                            <img src="${event.gameImage}" alt="Imagem do jogo ${event.game}" class="w-full md:w-48 h-auto object-cover rounded-md flex-shrink-0" onerror="this.onerror=null;this.src='${PLACEHOLDER_IMAGE}';">
                            <div class="flex-1">
                                <h4 class="text-xl font-bold text-white">${event.game}</h4>
                                <p class="text-sm bg-indigo-500 inline-block px-2 py-0.5 rounded-full my-2">${event.gameType}</p>
                                <div class="mt-2 text-sm">${certInfo}</div>
                                <div class="flex items-center gap-2 mt-3 pt-3 border-t border-gray-600">
                                   <img src="${event.providerImage}" alt="Logo de ${event.provider}" class="h-10 object-contain bg-gray-800 p-1 rounded" onerror="this.onerror=null;this.src='${PLACEHOLDER_PROVIDER_IMAGE}';">
                                    <span class="text-gray-300 font-semibold">${event.provider}</span>
                                </div>
                            </div>
                        </div>`;
                });

                modalContent.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-2xl font-bold text-indigo-300">Lançamentos de ${date.getDate()} de ${monthNames[date.getMonth()]}</h3>
                        <button id="close-modal-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                    </div>
                    <div class="space-y-4">${eventsHTML}</div>`;
                
                modal.classList.remove('hidden');
                document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            };
            
            const closeModal = () => modal.classList.add('hidden');

            const renderParticles = () => {
                for (let i = 0; i < 50; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    const size = Math.random() * 4 + 1;
                    particle.style.width = `${size}px`;
                    particle.style.height = `${size}px`;
                    particle.style.left = `${Math.random() * 100}%`;
                    particle.style.top = `${Math.random() * 100}%`;
                    particle.style.animationDuration = `${Math.random() * 20 + 10}s`;
                    particle.style.animationDelay = `${Math.random() * -30}s`;
                    particlesContainer.appendChild(particle);
                }
            };

            const handleProviderToggle = (provider) => {
                if (provider === 'All') {
                    selectedProviders = ['All'];
                } else {
                    let newSelection = selectedProviders.filter(p => p !== 'All');
                    if (newSelection.includes(provider)) {
                        newSelection = newSelection.filter(p => p !== provider);
                    } else {
                        newSelection.push(provider);
                    }
                    selectedProviders = newSelection.length === 0 ? ['All'] : newSelection;
                }
                renderFilters();
                renderCalendars();
            };
            
            const handleSearchInput = (e) => {
                searchQuery = e.target.value;
                const suggestions = getFilteredEvents().filter((_, index) => index < 5);
                
                if (searchQuery && suggestions.length > 0) {
                    autocompleteList.innerHTML = suggestions.map(event => 
                        `<div class="p-2 hover:bg-indigo-600 cursor-pointer" data-game="${event.game}">${event.game}</div>`
                    ).join('');
                    autocompleteList.classList.remove('hidden');
                } else {
                    autocompleteList.classList.add('hidden');
                }
                
                renderCalendars();
            };
            
            const handleSuggestionClick = (e) => {
                if (e.target.dataset.game) {
                    const selectedGame = e.target.dataset.game;
                    searchInput.value = selectedGame;
                    searchQuery = selectedGame;
                    autocompleteList.classList.add('hidden');
                    
                    const event = events.find(ev => ev.game === selectedGame);
                    if (event) {
                        currentDate = new Date(event.date);
                        currentDate.setDate(1);
                    }

                    renderCalendars();
                }
            };

            // --- LÓGICA DE INICIALIZAÇÃO ---
            const fetchData = async () => {
                try {
                    // MUDANÇA: Adicionado parâmetro para forçar a limpeza do cache.
                    const response = await fetch(`${CSV_URL}&cache_bust=${new Date().getTime()}`);
                    const csvText = await response.text();
                    const lines = csvText.split('\r\n').slice(1);

                    const parsedEvents = lines.map(line => {
                        const columns = line.split(',').map(c => c.trim().replace(/"/g, ''));
                        if (columns.length < 7) return null;
                        
                        const [dateStr, provider, game, gameType, providerImage, gameImage, certificate] = columns;
                        if (!dateStr || !provider || !game) return null;

                        const [day, month, year] = dateStr.split('/');
                        const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));

                        if (isNaN(date.getTime())) return null;

                        return { date, provider, game, gameType, gameImage: gameImage && gameImage.startsWith('http') ? gameImage : PLACEHOLDER_IMAGE, providerImage: providerImage && providerImage.startsWith('http') ? providerImage : PLACEHOLDER_PROVIDER_IMAGE, certificate: certificate || 'Não' };
                    }).filter(Boolean);

                    events = parsedEvents;
                    allProviders = ['All', ...new Set(parsedEvents.map(e => e.provider).filter(p => p))];
                    
                    renderFilters();
                    renderCalendars();
                } catch (error) {
                    console.error("Erro ao buscar dados do CSV:", error);
                    calendarsContainer.innerHTML = `<div class="text-center md:col-span-2 text-red-400">Falha ao carregar dados. Verifique a URL da planilha e a conexão.</div>`;
                }
            };

            // Adiciona os eventos
            prevBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 2); renderCalendars(); });
            nextBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 2); renderCalendars(); });
            todayBtn.addEventListener('click', () => { currentDate = new Date(); renderCalendars(); });
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
            searchInput.addEventListener('input', handleSearchInput);
            autocompleteList.addEventListener('click', handleSuggestionClick);
            document.addEventListener('click', (e) => { if (!e.target.closest('.relative')) autocompleteList.classList.add('hidden'); });

            // Inicia a aplicação
            renderParticles();
            fetchData();
        });
    </script>
</body>
</html>
