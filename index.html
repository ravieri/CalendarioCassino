<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calend√°rio de Lan√ßamentos - H2Bet & SeuBet</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-auth-compat.js"></script>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        @keyframes move { 100% { transform: translate3d(0, 0, 1px) rotate(360deg); } }
        .particle { position: absolute; border-radius: 50%; background: rgba(129, 140, 248, 0.2); animation: move linear infinite; transform-origin: center center; }
        .toast-enter { transform: translateY(100%); opacity: 0; }
        .toast-enter-active { transform: translateY(0); opacity: 1; transition: all 300ms ease-out; }
        .toast-exit { transform: translateY(0); opacity: 1; }
        .toast-exit-active { transform: translateY(100%); opacity: 0; transition: all 300ms ease-in; }
        @keyframes flash-red { 50% { background-color: #ef4444; } }
        .day-highlight { animation: flash-red 1.5s infinite ease-in-out; }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 5px #ef4444; } 50% { box-shadow: 0 0 20px #ef4444, 0 0 30px #ef4444; } }
        .card-highlight { border: 1px solid #ef4444; animation: glow 1.5s infinite ease-in-out; }
        .carousel-container { overflow: hidden; width: 100%; cursor: grab; }
        .carousel-container.grabbing { cursor: grabbing; }
        .carousel-wrapper { display: flex; }
        .carousel-slide { flex: 0 0 calc(100% / 3); box-sizing: border-box; padding: 0 8px; position: relative; }
        .carousel-slide img { width: 100%; height: 120px; object-fit: cover; border-radius: 0.5rem; border: 2px solid transparent; transition: border-color 0.3s; pointer-events: none; }
        .carousel-slide:hover img { border-color: #818cf8; }
        .carousel-slide .slide-title { position: absolute; bottom: 0; left: 8px; right: 8px; background: rgba(0, 0, 0, 0.7); color: white; padding: 4px 8px; font-size: 0.8rem; font-weight: 600; text-align: center; border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        @media (max-width: 1024px) { .carousel-slide { flex: 0 0 50%; } }
        @media (max-width: 640px) { .carousel-slide { flex: 0 0 100%; } }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans overflow-x-hidden">

    <div id="particles-js" class="absolute inset-0 z-0 overflow-hidden"></div>

    <main class="relative z-10 max-w-6xl mx-auto p-4 md:p-8">
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div id="highlight-carousel" class="carousel-container w-full md:w-2/3">
                <div id="carousel-wrapper" class="carousel-wrapper"></div>
            </div>
            
            <div class="flex items-center gap-2 flex-shrink-0 flex-wrap justify-end">
                <button id="login-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors font-semibold">Login</button>
                <button id="certificates-btn" class="px-4 py-2 bg-teal-600 hover:bg-teal-700 rounded-lg transition-colors font-semibold flex items-center gap-2 hidden">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Certificados
                </button>
                <button id="add-game-btn" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition-colors font-semibold flex items-center gap-2 hidden"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>Adicionar Jogo</button>
                <button id="extraction-btn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors font-semibold flex items-center gap-2 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    Extra√ß√£o
                </button>
                
                <button id="logout-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition-colors font-semibold hidden">Logout</button>
                <button id="prev-btn" class="px-4 py-2 bg-gray-700 hover:bg-indigo-500 rounded-lg transition-colors">‚Äπ‚Äπ</button>
                <button id="today-btn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg transition-colors font-semibold">Hoje</button>
                <button id="next-btn" class="px-4 py-2 bg-gray-700 hover:bg-indigo-500 rounded-lg transition-colors">‚Ä∫‚Ä∫</button>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="relative"><label for="search-input" class="block text-sm font-medium text-gray-300 mb-1">Pesquisar por Jogo:</label><input type="text" id="search-input" placeholder="Digite o nome do jogo..." class="w-full bg-gray-700 text-white placeholder-gray-400 rounded-lg p-2 border-2 border-transparent focus:border-indigo-500 focus:ring-0 transition"><div id="autocomplete-list" class="absolute z-20 w-full bg-gray-700 rounded-b-lg mt-1 max-h-60 overflow-y-auto hidden"></div></div>
            <div class="relative"><label for="toggle-filter-btn" class="block text-sm font-medium text-gray-300 mb-1">Filtrar por Provedor:</label><button id="toggle-filter-btn" class="w-full flex justify-between items-center bg-gray-700 rounded-lg p-2"><span id="filter-label">Todos os Provedores</span><svg id="filter-chevron" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></button><div id="filter-options" class="absolute hidden z-20 w-full mt-1 bg-gray-800 border border-gray-700 rounded-lg shadow-lg p-4 max-h-60 overflow-y-auto"><div id="filters-container" class="flex flex-wrap gap-2"><div class="text-gray-400">Carregando filtros...</div></div></div></div>
            <div class="relative">
                <label for="cert-filter" class="block text-sm font-medium text-gray-300 mb-1">Certificado (Ambas as Marcas):</label>
                <select id="cert-filter" class="w-full bg-gray-700 text-white rounded-lg p-2 border-2 border-transparent focus:border-indigo-500 focus:ring-0 transition outline-none">
                    <option value="All">Todos os Jogos</option>
                    <option value="Yes">Sim (Possui em Ambas)</option>
                    <option value="No">N√£o (Falta em pelo menos uma)</option>
                </select>
            </div>
        </div>

        <div id="calendars-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="text-center md:col-span-2 text-gray-400">Carregando calend√°rios...</div></div>
    </main>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4 hidden"><div id="modal-content" class="bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto p-6"></div></div>
    
    <div id="certificates-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-3xl h-[80vh] flex flex-col p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-teal-300">Gest√£o de Certificados</h3>
                <button id="close-certificates-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="mb-4">
                <input type="text" id="cert-modal-search" placeholder="Buscar jogo..." class="w-full bg-gray-700 text-white placeholder-gray-400 rounded-lg p-3 border border-gray-600 focus:border-teal-500 outline-none">
            </div>
            <div class="flex justify-between text-xs text-gray-400 font-bold uppercase mb-2 px-4">
                <span>Jogo</span>
                <span class="mr-4">Status (H2Bet / SeuBet)</span>
            </div>
            <div id="cert-modal-list" class="flex-1 overflow-y-auto space-y-2 pr-2 custom-scrollbar">
                </div>
        </div>
    </div>

    <div id="cert-history-popup" class="fixed bottom-5 right-5 z-[60] bg-gray-800 border border-gray-700 rounded-lg shadow-2xl w-80 flex flex-col hidden transition-transform duration-300">
        <div id="cert-history-header" class="bg-teal-600 hover:bg-teal-700 text-white p-3 rounded-t-lg flex justify-between items-center cursor-pointer transition-colors">
            <span class="font-bold text-sm flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg> Hist√≥rico de Certificados</span>
            <svg id="cert-history-chevron" class="w-5 h-5 transform rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
        </div>
        <div id="cert-history-body" class="p-3 max-h-60 overflow-y-auto space-y-3 hidden bg-gray-900 border-t border-gray-700">
            </div>
        <div id="cert-history-footer" class="p-2 bg-gray-900 rounded-b-lg border-t border-gray-700 hidden">
            <button id="open-full-history-btn" class="w-full text-xs text-teal-400 hover:text-teal-300 font-semibold text-center py-1 flex items-center justify-center gap-1 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                Ver Hist√≥rico Completo
            </button>
        </div>
    </div>

    <div id="full-history-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl h-[80vh] flex flex-col p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-teal-300">Hist√≥rico Completo de Certificados</h3>
                <button id="close-full-history-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="mb-4">
                <input type="text" id="full-history-search" placeholder="Pesquisar por nome do jogo..." class="w-full bg-gray-700 text-white placeholder-gray-400 rounded-lg p-3 border border-gray-600 focus:border-teal-500 outline-none transition">
            </div>
            <div id="full-history-list" class="flex-1 overflow-y-auto space-y-2 pr-2 custom-scrollbar">
            </div>
        </div>
    </div>

    <div id="add-game-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4 hidden">
        <form id="add-game-form" class="bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6 space-y-4">
            <h3 class="text-2xl font-bold text-indigo-300 mb-4">Adicionar Novo Lan√ßamento</h3>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium text-gray-300">Data</label><input type="date" name="data" required class="w-full bg-gray-700 rounded-lg p-2 mt-1 text-white" style="color-scheme: dark;"></div>
                <div><label class="block text-sm font-medium text-gray-300">Provedor</label><select name="provedor" required class="w-full bg-gray-700 rounded-lg p-2 mt-1 text-white"></select></div>
            </div>
            <div><label class="block text-sm font-medium text-gray-300">Jogo</label><input type="text" name="jogo" required class="w-full bg-gray-700 rounded-lg p-2 mt-1"></div>
            <div><label class="block text-sm font-medium text-gray-300">Tipo de jogo</label><input type="text" name="tipodejogo" class="w-full bg-gray-700 rounded-lg p-2 mt-1"></div>
            <div><label class="block text-sm font-medium text-gray-300">Imagem (URL)</label><input type="url" name="imagem" placeholder="https://..." class="w-full bg-gray-700 rounded-lg p-2 mt-1"></div>
            <div><label class="block text-sm font-medium text-gray-300">Imagem do Provedor (URL)</label><input type="url" name="imagemprovedor" placeholder="Selecione um provedor para preencher" readonly class="w-full bg-gray-600 rounded-lg p-2 mt-1"></div>
            <div><label class="block text-sm font-medium text-gray-300">Volatilidade</label><div id="add-volatility-meter" class="w-full h-8 grid grid-cols-4 gap-1 mt-1"></div><input type="hidden" name="volatilidade"></div>
            
            <hr class="border-gray-600 my-4">
            <h4 class="text-lg font-semibold text-gray-200">Status por Plataforma</h4>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="bg-gray-700 p-4 rounded-lg space-y-3">
                    <h5 class="font-bold text-indigo-300">H2Bet</h5>
                    <div><label class="block text-sm font-medium text-gray-300">Certificado</label><div class="flex gap-4 mt-1"><label class="flex items-center"><input type="radio" name="h2bet_certificado" value="Sim" class="mr-2">Sim</label><label class="flex items-center"><input type="radio" name="h2bet_certificado" value="N√£o" class="mr-2" checked>N√£o</label></div></div>
                    <div><label class="block text-sm font-medium text-gray-300">Ativo no site?</label><div class="flex gap-4 mt-1"><label class="flex items-center"><input type="radio" name="h2bet_ativo" value="Sim" class="mr-2">Sim</label><label class="flex items-center"><input type="radio" name="h2bet_ativo" value="N√£o" class="mr-2" checked>N√£o</label></div></div>
                    <div><label class="block text-sm font-medium text-gray-300">Destaque?</label><div class="flex gap-4 mt-1"><label class="flex items-center"><input type="radio" name="h2bet_destaque" value="S" class="mr-2">Sim</label><label class="flex items-center"><input type="radio" name="h2bet_destaque" value="N" class="mr-2" checked>N√£o</label></div></div>
                </div>
                 <div class="bg-gray-700 p-4 rounded-lg space-y-3">
                    <h5 class="font-bold text-green-300">SeuBet</h5>
                    <div><label class="block text-sm font-medium text-gray-300">Certificado</label><div class="flex gap-4 mt-1"><label class="flex items-center"><input type="radio" name="seubet_certificado" value="Sim" class="mr-2">Sim</label><label class="flex items-center"><input type="radio" name="seubet_certificado" value="N√£o" class="mr-2" checked>N√£o</label></div></div>
                    <div><label class="block text-sm font-medium text-gray-300">Ativo no site?</label><div class="flex gap-4 mt-1"><label class="flex items-center"><input type="radio" name="seubet_ativo" value="Sim" class="mr-2">Sim</label><label class="flex items-center"><input type="radio" name="seubet_ativo" value="N√£o" class="mr-2" checked>N√£o</label></div></div>
                    <div><label class="block text-sm font-medium text-gray-300">Destaque?</label><div class="flex gap-4 mt-1"><label class="flex items-center"><input type="radio" name="seubet_destaque" value="S" class="mr-2">Sim</label><label class="flex items-center"><input type="radio" name="seubet_destaque" value="N" class="mr-2" checked>N√£o</label></div></div>
                </div>
            </div>

            <div class="flex justify-end gap-4 pt-4">
                <button type="button" id="cancel-add-game-btn" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg">Cancelar</button>
                <button type="submit" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg font-semibold">Salvar Jogo</button>
            </div>
        </form>
    </div>
    
    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4 hidden"><form id="login-form" class="bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 space-y-4"><h3 class="text-2xl font-bold text-indigo-300 mb-4">Login de Administrador</h3><div><label class="block text-sm font-medium text-gray-300">E-mail</label><input type="email" name="email" required class="w-full bg-gray-700 rounded-lg p-2 mt-1"></div><div><label class="block text-sm font-medium text-gray-300">Senha</label><input type="password" name="password" required class="w-full bg-gray-700 rounded-lg p-2 mt-1"></div><div class="flex justify-end gap-4 pt-4"><button type="button" id="cancel-login-btn" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold">Entrar</button></div></form></div>
    <div id="add-provider-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4 hidden"><form id="add-provider-form" class="bg-gray-900 rounded-lg shadow-xl w-full max-w-sm p-6 space-y-4"><h3 class="text-2xl font-bold text-indigo-300 mb-4">Adicionar Novo Provedor</h3><div><label class="block text-sm font-medium text-gray-300">Nome do Provedor</label><input type="text" name="provider-name" required class="w-full bg-gray-700 rounded-lg p-2 mt-1"></div><div><label class="block text-sm font-medium text-gray-300">URL da Imagem (Logo)</label><input type="url" name="provider-logo" required placeholder="https://..." class="w-full bg-gray-700 rounded-lg p-2 mt-1"></div><div class="flex justify-end gap-4 pt-4"><button type="button" id="cancel-add-provider-btn" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg">Cancelar</button><button type="submit" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg font-semibold">Salvar Provedor</button></div></form></div>
    
    <div id="extraction-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 space-y-4">
            <h3 class="text-2xl font-bold text-purple-300 mb-4">Extrair Relat√≥rio</h3>
            <p class="text-gray-400 text-sm">Selecione o per√≠odo para gerar o Excel.</p>
            
            <div class="flex items-center justify-between bg-gray-700 p-2 rounded-lg mb-2">
                <span class="text-sm text-gray-200">Selecionar m√∫ltiplos meses?</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="multi-month-toggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                </label>
            </div>

            <div id="single-month-container">
                <label class="block text-sm font-medium text-gray-300">M√™s de Refer√™ncia</label>
                <input type="month" id="extraction-month" class="w-full bg-gray-700 rounded-lg p-2 mt-1 text-white" style="color-scheme: dark;">
            </div>

            <div id="multi-month-container" class="hidden space-y-2">
                <div class="flex items-center gap-2 mb-2">
                    <input type="checkbox" id="select-all-months" class="w-4 h-4 text-purple-600 bg-gray-700 border-gray-600 rounded">
                    <label for="select-all-months" class="text-sm font-medium text-white">Todos os meses dispon√≠veis</label>
                </div>
                <label class="block text-sm font-medium text-gray-300">Selecione os meses:</label>
                <div id="month-selection-grid" class="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto bg-gray-900 p-2 rounded border border-gray-700">
                    </div>
            </div>

            <div class="flex justify-end gap-4 pt-4">
                <button type="button" id="cancel-extraction-btn" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg">Cancelar</button>
                <button type="button" id="confirm-extraction-btn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold flex items-center gap-2">
                    Baixar Excel
                </button>
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed bottom-20 md:bottom-5 right-5 z-[70] flex flex-col gap-2 pointer-events-none"></div>

    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #374151; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        #toast-container > div { pointer-events: auto; }
    </style>

    <script>
    // --- INICIALIZA√á√ÉO DO FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyDozLqKLCJaAdEi5yS1FooiTvrNI3CRmSw",
        authDomain: "calendarioh-6da51.firebaseapp.com",
        projectId: "calendarioh-6da51",
        storageBucket: "calendarioh-6da51.firebasestorage.app",
        messagingSenderId: "731803901078",
        appId: "1:731803901078:web:739b77ea4b358f230df6b7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    // --- FIM DA INICIALIZA√á√ÉO ---

    document.addEventListener('DOMContentLoaded', () => {
        const PLACEHOLDER_IMAGE = 'https://placehold.co/400x300/2A2E3B/FFFFFF?text=Sem+Imagem';
        const PLACEHOLDER_PROVIDER_IMAGE = 'https://placehold.co/100x40/374151/FFFFFF?text=Provedor';
        let events = [], allProviders = [], providerData = [], selectedProviders = ['All'], searchQuery = '', currentDate = new Date();
        let carouselInterval = null;
        let editMode = { active: false, originalId: null };
        let isDown = false, startX, scrollLeft, hasDragged = false;
        let certFilterValue = 'All';
        let certModalSearchQuery = '';
        let unsubscribeHistory = null;
        let currentOpenedModalDate = null; 
        const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"], weekDays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
        
        const domRefs = { 
            calendarsContainer: document.getElementById('calendars-container'), 
            filtersContainer: document.getElementById('filters-container'), 
            searchInput: document.getElementById('search-input'), 
            autocompleteList: document.getElementById('autocomplete-list'), 
            prevBtn: document.getElementById('prev-btn'), 
            nextBtn: document.getElementById('next-btn'), 
            todayBtn: document.getElementById('today-btn'), 
            modal: document.getElementById('modal'), 
            modalContent: document.getElementById('modal-content'), 
            particlesContainer: document.getElementById('particles-js'), 
            toastContainer: document.getElementById('toast-container'), 
            addGameModal: document.getElementById('add-game-modal'), 
            addGameBtn: document.getElementById('add-game-btn'), 
            cancelAddGameBtn: document.getElementById('cancel-add-game-btn'), 
            addGameForm: document.getElementById('add-game-form'), 
            addVolatilityMeter: document.getElementById('add-volatility-meter'), 
            toggleFilterBtn: document.getElementById('toggle-filter-btn'), 
            filterOptions: document.getElementById('filter-options'), 
            filterLabel: document.getElementById('filter-label'), 
            filterChevron: document.getElementById('filter-chevron'), 
            carouselContainer: document.getElementById('highlight-carousel'), 
            carouselWrapper: document.getElementById('carousel-wrapper'), 
            loginBtn: document.getElementById('login-btn'), 
            logoutBtn: document.getElementById('logout-btn'), 
            loginModal: document.getElementById('login-modal'), 
            loginForm: document.getElementById('login-form'), 
            cancelLoginBtn: document.getElementById('cancel-login-btn'), 
            addProviderModal: document.getElementById('add-provider-modal'), 
            addProviderForm: document.getElementById('add-provider-form'), 
            cancelAddProviderBtn: document.getElementById('cancel-add-provider-btn'), 
            extractionBtn: document.getElementById('extraction-btn'),
            extractionModal: document.getElementById('extraction-modal'),
            cancelExtractionBtn: document.getElementById('cancel-extraction-btn'),
            confirmExtractionBtn: document.getElementById('confirm-extraction-btn'),
            extractionMonthInput: document.getElementById('extraction-month'),
            certFilter: document.getElementById('cert-filter'),
            certificatesBtn: document.getElementById('certificates-btn'),
            certificatesModal: document.getElementById('certificates-modal'),
            closeCertificatesBtn: document.getElementById('close-certificates-btn'),
            certModalSearch: document.getElementById('cert-modal-search'),
            certModalList: document.getElementById('cert-modal-list'),
            certHistoryPopup: document.getElementById('cert-history-popup'),
            certHistoryHeader: document.getElementById('cert-history-header'),
            certHistoryBody: document.getElementById('cert-history-body'),
            certHistoryChevron: document.getElementById('cert-history-chevron'),
            certHistoryFooter: document.getElementById('cert-history-footer'),
            fullHistoryModal: document.getElementById('full-history-modal'),
            closeFullHistoryBtn: document.getElementById('close-full-history-btn'),
            fullHistorySearch: document.getElementById('full-history-search'),
            fullHistoryList: document.getElementById('full-history-list'),
            openFullHistoryBtn: document.getElementById('open-full-history-btn')
        };
        
        const extractionRefs = {
            toggle: document.getElementById('multi-month-toggle'),
            singleContainer: document.getElementById('single-month-container'),
            multiContainer: document.getElementById('multi-month-container'),
            selectAll: document.getElementById('select-all-months'),
            grid: document.getElementById('month-selection-grid')
        };

        auth.onAuthStateChanged(user => {
            if (user) {
                domRefs.loginBtn.classList.add('hidden');
                domRefs.addGameBtn.classList.remove('hidden');
                domRefs.logoutBtn.classList.remove('hidden');
                domRefs.extractionBtn.classList.remove('hidden');
                domRefs.certificatesBtn.classList.remove('hidden');
                listenToCertificateHistory();
            } else {
                domRefs.loginBtn.classList.remove('hidden');
                domRefs.addGameBtn.classList.add('hidden');
                domRefs.logoutBtn.classList.add('hidden');
                domRefs.extractionBtn.classList.add('hidden');
                domRefs.certificatesBtn.classList.add('hidden');
                domRefs.certHistoryPopup.classList.add('hidden');
                if (unsubscribeHistory) unsubscribeHistory();
            }
        });
        
        const fetchData = async () => {
            try {
                const [h2betSnapshot, seubetSnapshot, provedoresSnapshot] = await Promise.all([
                    db.collection('jogos').get(),
                    db.collection('jogosseubet').get(),
                    db.collection('provedores').orderBy('nome').get()
                ]);

                providerData = [];
                provedoresSnapshot.forEach(doc => { providerData.push({ name: doc.data().nome, link: doc.data().logoUrl }); });
                allProviders = ['All', ...providerData.map(p => p.name)];

                const seubetStatusMap = new Map();
                seubetSnapshot.forEach(doc => {
                    const data = doc.data(); const gameName = data.Jogo?.trim();
                    if (gameName) {
                        seubetStatusMap.set(gameName, { ativo: data['Ativo no site?'] || 'N√£o', certificado: data.Certificado || 'N√£o', destaque: data.Destaque || 'N' });
                    }
                });

                events = [];
                
                h2betSnapshot.forEach(doc => {
                    const data = doc.data();
                    const hasError = !data.Jogo || typeof data.Jogo !== 'string' || !data.Data;
                    const gameName = data.Jogo?.trim() || doc.id;
                    const gameDate = data.Data ? data.Data.toDate() : null;

                    const eventData = {
                        game: gameName, date: gameDate, provider: data.Provedor || '[N/A]', gameType: data['Tipo de jogo'] || '[N/A]', gameImage: (data.Imagem && data.Imagem.startsWith('http')) ? data.Imagem : PLACEHOLDER_IMAGE, providerImage: (data['Imagem provedor'] && data['Imagem provedor'].startsWith('http')) ? data['Imagem provedor'] : PLACEHOLDER_PROVIDER_IMAGE, volatility: data.Volatilidade || 'N/D',
                        h2bet_ativo: data['Ativo no site?'] || 'N/A', h2bet_certificado: data.Certificado || 'N/A', h2bet_destaque: data.Destaque || 'N/A',
                        seubet_ativo: seubetStatusMap.get(gameName)?.ativo || 'N√£o', seubet_certificado: seubetStatusMap.get(gameName)?.certificado || 'N√£o', seubet_destaque: seubetStatusMap.get(gameName)?.destaque || 'N√£o',
                        hasError: hasError
                    };

                    if (!hasError) { events.push(eventData); }
                });
                
                renderFilters(); renderCalendars(); renderCarousel();
                
                if (!domRefs.certificatesModal.classList.contains('hidden')) {
                    renderCertificatesList();
                }

                if (!domRefs.modal.classList.contains('hidden') && currentOpenedModalDate) {
                    const dayEvents = getFilteredEvents().filter(e => 
                        e.date && e.date.toDateString() === currentOpenedModalDate.toDateString()
                    );
                    renderModalContent(currentOpenedModalDate, dayEvents);
                }

            } catch (error) {
                console.error("Erro ao buscar e processar dados:", error);
                domRefs.calendarsContainer.innerHTML = `<div class="text-center md-col-span-2 text-red-400">Falha ao carregar dados.</div>`;
            }
        };

        const listenToCertificateHistory = () => {
            if (!auth.currentUser) return;
            domRefs.certHistoryPopup.classList.remove('hidden');

            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

            unsubscribeHistory = db.collection('historico_certificados')
                .where('timestamp', '>=', sevenDaysAgo)
                .orderBy('timestamp', 'desc')
                .onSnapshot(snapshot => {
                    if (snapshot.empty) {
                        domRefs.certHistoryBody.innerHTML = '<div class="text-sm text-gray-400 text-center py-4">Nenhuma altera√ß√£o recente.</div>';
                        return;
                    }

                    let itemsHTML = '';
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const time = data.timestamp ? data.timestamp.toDate().toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute:'2-digit' }) : 'Agora';
                        const isSim = (data.newValue || '').toLowerCase() === 'sim' || (data.newValue || '').toLowerCase() === 's';
                        const colorClass = isSim ? 'text-green-400' : 'text-red-400';
                        const arrow = isSim ? '‚Üë' : '‚Üì';
                        
                        itemsHTML += `
                            <div class="border-b border-gray-700 pb-2 mb-2 last:border-0 last:pb-0 last:mb-0">
                                <div class="flex justify-between items-center">
                                    <strong class="text-white text-sm truncate pr-2">${data.gameName}</strong>
                                    <span class="text-[10px] text-gray-500 flex-shrink-0">${time}</span>
                                </div>
                                <div class="text-xs text-gray-300 mt-1 flex items-center gap-1">
                                    <span class="${data.platform === 'H2Bet' ? 'text-indigo-300' : 'text-green-300'} font-semibold">${data.platform}:</span>
                                    <span class="line-through text-gray-500">${data.oldValue}</span>
                                    <span>${arrow}</span>
                                    <span class="${colorClass} font-bold">${data.newValue}</span>
                                </div>
                            </div>
                        `;
                    });

                    domRefs.certHistoryBody.innerHTML = itemsHTML;
                    
                    if (snapshot.docChanges().length > 0 && domRefs.certHistoryBody.classList.contains('hidden')) {
                        domRefs.certHistoryHeader.classList.add('bg-teal-500');
                        setTimeout(() => domRefs.certHistoryHeader.classList.remove('bg-teal-500'), 1000);
                    }
                }, error => {
                    console.error("Erro ao buscar hist√≥rico de certificados:", error);
                });
        };

        domRefs.certHistoryHeader.onclick = () => {
            const isHidden = domRefs.certHistoryBody.classList.contains('hidden');
            if (isHidden) {
                domRefs.certHistoryBody.classList.remove('hidden');
                domRefs.certHistoryFooter.classList.remove('hidden');
                domRefs.certHistoryChevron.classList.remove('rotate-180');
            } else {
                domRefs.certHistoryBody.classList.add('hidden');
                domRefs.certHistoryFooter.classList.add('hidden');
                domRefs.certHistoryChevron.classList.add('rotate-180');
            }
        };

        // --- L√ìGICA DO HIST√ìRICO COMPLETO ---
        let fullHistoryData = [];

        const renderFullHistoryList = (query = '') => {
            const filtered = fullHistoryData.filter(item => item.gameName.toLowerCase().includes(query.toLowerCase()));
            
            if (filtered.length === 0) {
                domRefs.fullHistoryList.innerHTML = '<div class="text-gray-400 text-center py-8 font-semibold">Nenhum registro encontrado com esta busca.</div>';
                return;
            }

            domRefs.fullHistoryList.innerHTML = filtered.map(data => {
                const time = data.timestamp ? data.timestamp.toDate().toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute:'2-digit' }) : 'Agora';
                const isSim = (data.newValue || '').toLowerCase() === 'sim' || (data.newValue || '').toLowerCase() === 's';
                const colorClass = isSim ? 'text-green-400' : 'text-red-400';
                const arrow = isSim ? '‚Üë' : '‚Üì';

                return `
                    <div class="bg-gray-700 hover:bg-gray-600 transition-colors p-3 rounded-lg flex flex-col md:flex-row justify-between md:items-center gap-3 border border-gray-600 mb-2">
                        <div class="font-bold text-white flex-1 truncate text-lg">${data.gameName}</div>
                        <div class="flex flex-col md:flex-row items-start md:items-center gap-3 md:gap-6">
                            <div class="flex items-center gap-2 text-sm bg-gray-800 px-3 py-1.5 rounded-lg border border-gray-700">
                                <span class="${data.platform === 'H2Bet' ? 'text-indigo-300' : 'text-green-300'} font-semibold">${data.platform}:</span>
                                <span class="line-through text-gray-500">${data.oldValue}</span>
                                <span class="text-gray-400">${arrow}</span>
                                <span class="${colorClass} font-bold">${data.newValue}</span>
                            </div>
                            <div class="text-xs text-gray-400 font-medium whitespace-nowrap min-w-[120px] text-right">
                                üìÖ ${time}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        };

        const openFullHistoryModal = async () => {
            domRefs.fullHistoryModal.classList.remove('hidden');
            domRefs.fullHistoryList.innerHTML = '<div class="text-center text-teal-400 mt-10 font-bold animate-pulse">Consultando banco de dados completo...</div>';
            domRefs.fullHistorySearch.value = '';

            try {
                const snapshot = await db.collection('historico_certificados').orderBy('timestamp', 'desc').get();
                fullHistoryData = [];
                snapshot.forEach(doc => fullHistoryData.push({ id: doc.id, ...doc.data() }));
                
                renderFullHistoryList();
            } catch (error) {
                console.error("Erro ao buscar hist√≥rico completo:", error);
                domRefs.fullHistoryList.innerHTML = `<div class="text-red-400 text-center py-8">Falha ao carregar: ${error.message}</div>`;
            }
        };

        domRefs.openFullHistoryBtn.onclick = openFullHistoryModal;
        domRefs.closeFullHistoryBtn.onclick = () => domRefs.fullHistoryModal.classList.add('hidden');
        domRefs.fullHistorySearch.oninput = (e) => renderFullHistoryList(e.target.value);
        
        domRefs.fullHistoryModal.onclick = (e) => { 
            if (e.target === domRefs.fullHistoryModal) domRefs.fullHistoryModal.classList.add('hidden'); 
        };
        // --- FIM DA L√ìGICA DO HIST√ìRICO COMPLETO ---

        const renderCertificatesList = () => {
            const listContainer = domRefs.certModalList;
            const filtered = events.filter(e => !certModalSearchQuery || e.game.toLowerCase().includes(certModalSearchQuery.toLowerCase()));
            
            if(filtered.length === 0) {
                listContainer.innerHTML = '<div class="text-gray-400 text-center py-8">Nenhum jogo encontrado na busca.</div>';
                return;
            }

            listContainer.innerHTML = filtered.map(event => {
                const getBtnHTML = (platform, platformColor, dbField, fieldValue) => {
                    const isPositive = (fieldValue || '').toLowerCase() === 'sim' || (fieldValue || '').toLowerCase() === 's';
                    const newValue = isPositive ? 'N√£o' : 'Sim';
                    const btnClass = isPositive ? 'bg-teal-600 hover:bg-teal-700 text-white' : 'bg-gray-600 hover:bg-gray-500 text-gray-300';
                    return `
                        <button class="px-3 py-1 rounded text-xs font-bold transition-colors w-16 text-center ${btnClass} ring-1 ring-black/20" 
                                data-action="updateField" data-game-name="${event.game}" data-field-name="${dbField}" data-new-value="${newValue}">
                            ${isPositive ? 'SIM' : 'N√ÉO'}
                        </button>
                    `;
                };

                return `
                    <div class="bg-gray-700 hover:bg-gray-600 transition-colors p-3 rounded-lg flex flex-col md:flex-row justify-between md:items-center gap-3 border border-gray-600">
                        <div class="font-bold text-white flex-1 flex items-center gap-2">
                            <img src="${event.providerImage}" class="h-5 w-auto rounded bg-gray-800 p-0.5" onerror="this.onerror=null;this.style.display='none';">
                            ${event.game}
                        </div>
                        <div class="flex items-center gap-4 justify-end md:w-auto w-full">
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-semibold text-indigo-300 w-12 text-right">H2Bet:</span>
                                ${getBtnHTML('H2Bet', 'text-indigo-300', 'h2bet_certificado', event.h2bet_certificado)}
                            </div>
                            <div class="w-px h-6 bg-gray-500 hidden md:block"></div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-semibold text-green-300 w-14 text-right">SeuBet:</span>
                                ${getBtnHTML('SeuBet', 'text-green-300', 'seubet_certificado', event.seubet_certificado)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            listContainer.querySelectorAll('[data-action="updateField"]').forEach(element => { 
                const { gameName, fieldName, newValue } = element.dataset; 
                element.onclick = async () => await updateSheetField(gameName, fieldName, newValue); 
            });
        };

        domRefs.certificatesBtn.onclick = () => {
            certModalSearchQuery = ''; domRefs.certModalSearch.value = '';
            renderCertificatesList(); domRefs.certificatesModal.classList.remove('hidden');
        };
        domRefs.closeCertificatesBtn.onclick = () => domRefs.certificatesModal.classList.add('hidden');
        domRefs.certModalSearch.oninput = (e) => { certModalSearchQuery = e.target.value; renderCertificatesList(); };
        domRefs.certFilter.addEventListener('change', (e) => { certFilterValue = e.target.value; renderCalendars(); });

        const showToast = (message, type = 'success') => {
            const toast = document.createElement('div');
            toast.className = `${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white py-2 px-4 rounded-lg shadow-lg toast-enter text-sm font-semibold max-w-xs`;
            toast.textContent = message;
            domRefs.toastContainer.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('toast-enter-active'));
            setTimeout(() => { toast.classList.remove('toast-enter-active'); toast.classList.add('toast-exit-active'); toast.addEventListener('transitionend', () => toast.remove()); }, 3000);
        };
        
        const createVolatilityMeterHTML = (level, gameName) => {
            const levels = { baixo: 'Baixa', medio: 'M√©dia', alto: 'Alta', 'muito alto': 'Muito Alta' };
            const colors = { baixo: 'bg-green-500', medio: 'bg-yellow-500', alto: 'bg-orange-500', 'muito alto': 'bg-red-500'};
            const normalizedLevel = (level || '').toLowerCase().trim().replace('√©', 'e');
            let barsHTML = Object.keys(levels).map(key => `<div class="h-full rounded cursor-pointer ${Object.keys(levels).indexOf(normalizedLevel) >= Object.keys(levels).indexOf(key) ? colors[key] : 'bg-gray-600 hover:bg-gray-500'}" data-action="updateVolatility" data-level="${key}" data-game-name="${gameName}" title="Definir volatilidade como ${levels[key]}"></div>`).join('');
            return `<div><span class="text-sm font-semibold text-gray-300">Volatilidade: ${levels[normalizedLevel] || 'N/D'}</span><div class="w-full h-4 grid grid-cols-4 gap-1 mt-1">${barsHTML}</div></div>`;
        };
        
        const getFilteredEvents = () => events.filter(event => {
            const matchProvider = selectedProviders.includes('All') || selectedProviders.includes(event.provider);
            const matchSearch = !searchQuery || event.game.toLowerCase().includes(searchQuery.toLowerCase());
            
            let matchCert = true;
            const h2Cert = (event.h2bet_certificado || '').toLowerCase();
            const seuCert = (event.seubet_certificado || '').toLowerCase();
            const hasH2 = h2Cert === 'sim' || h2Cert === 's';
            const hasSeu = seuCert === 'sim' || seuCert === 's';

            if (certFilterValue === 'Yes') { matchCert = hasH2 && hasSeu; } 
            else if (certFilterValue === 'No') { matchCert = !(hasH2 && hasSeu); }

            return matchProvider && matchSearch && matchCert;
        });
        
        const renderFilters = () => {
            domRefs.filtersContainer.innerHTML = '';
            allProviders.forEach(provider => { const button = document.createElement('button'); button.textContent = provider; button.className = `px-3 py-1 text-sm rounded-full transition-all duration-200 ${selectedProviders.includes(provider) ? 'bg-indigo-500 text-white shadow-lg' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`; button.onclick = () => handleProviderToggle(provider); domRefs.filtersContainer.appendChild(button); });
            updateFilterLabel();
        };

        const renderCalendars = () => {
            domRefs.calendarsContainer.innerHTML = '';
            const calendarData = [{ year: currentDate.getFullYear(), month: currentDate.getMonth() }];
            const nextMonthDate = new Date(currentDate);
            nextMonthDate.setDate(1); 
            nextMonthDate.setMonth(nextMonthDate.getMonth() + 1);
            calendarData.push({ year: nextMonthDate.getFullYear(), month: nextMonthDate.getMonth() });
            
            const filteredEvents = getFilteredEvents();
            
            calendarData.forEach(({ year, month }) => 
                domRefs.calendarsContainer.insertAdjacentHTML('beforeend', createCalendarHTML(year, month, filteredEvents))
            );
            
            domRefs.calendarsContainer.querySelectorAll('.calendar-day').forEach(dayCell => { 
                const day = parseInt(dayCell.dataset.day); 
                const year = parseInt(dayCell.dataset.year);
                const month = parseInt(dayCell.dataset.month);

                const dayEvents = getFilteredEvents().filter(e => 
                    e.date && e.date.getFullYear() === year && e.date.getMonth() === month && e.date.getDate() === day
                ); 
                
                if (dayEvents.length > 0) {
                    dayCell.onclick = () => renderModal(new Date(year, month, day), dayEvents); 
                }
            });
        };

        const createCalendarHTML = (year, month, filteredEvents) => {
            let daysHTML = '';
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            for (let i = 0; i < firstDayOfMonth; i++) daysHTML += `<div></div>`;
            for (let day = 1; day <= new Date(year, month + 1, 0).getDate(); day++) {
                const dayEvents = filteredEvents.filter(e => e.date && e.date.getFullYear() === year && e.date.getMonth() === month && e.date.getDate() === day);
                const isToday = new Date().toDateString() === new Date(year, month, day).toDateString();
                const isSearched = searchQuery && dayEvents.length > 0;
                const hasHighlight = dayEvents.some(e => (e.h2bet_destaque && e.h2bet_destaque.toLowerCase() === 's') || (e.seubet_destaque && e.seubet_destaque.toLowerCase() === 's'));
                let dayClasses = `calendar-day relative p-2 rounded-lg transition-colors duration-200 aspect-square flex items-center justify-center ${dayEvents.length > 0 ? 'cursor-pointer hover:bg-indigo-700 bg-gray-700' : 'text-gray-500'} ${isToday ? 'bg-indigo-500 !text-white font-bold' : ''} ${isSearched ? '!bg-green-500 ring-2 ring-white' : ''} ${hasHighlight ? 'day-highlight' : ''}`;
                daysHTML += `<div class="${dayClasses}" data-day="${day}" data-month="${month}" data-year="${year}"><span>${day}</span>${dayEvents.length > 0 ? `<span class="absolute top-1 right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center shadow-md">${dayEvents.length}</span>` : ''}</div>`;
            }
            return `<div class="bg-gray-800 bg-opacity-50 backdrop-blur-sm p-4 rounded-lg shadow-2xl"><h2 class="text-xl font-bold text-center mb-4 text-indigo-300">${monthNames[month]} ${year}</h2><div class="grid grid-cols-7 gap-1 text-center">${weekDays.map(d => `<div class="font-semibold text-xs text-gray-400">${d}</div>`).join('')}${daysHTML}</div></div>`;
        };
        
        const closeModal = () => { domRefs.modal.classList.add('hidden'); currentOpenedModalDate = null; };
        
        const renderModal = (date, dayEvents) => { 
            currentOpenedModalDate = date; 
            renderModalContent(date, dayEvents); 
            domRefs.modal.classList.remove('hidden'); 
        };

        const renderModalContent = (date, dayEvents) => {
            domRefs.modalContent.innerHTML = `<div class="flex justify-between items-center mb-4"><h3 class="text-2xl font-bold text-indigo-300">Lan√ßamentos de ${date.getDate()} de ${monthNames[date.getMonth()]}</h3><button id="close-modal-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button></div><div class="space-y-4">${dayEvents.map(event => createEventCardHTML(event)).join('')}</div>`;
            document.getElementById('close-modal-btn').onclick = closeModal;
            domRefs.modalContent.querySelectorAll('[data-action="updateField"]').forEach(element => { const { gameName, fieldName, newValue } = element.dataset; element.onclick = async () => await updateSheetField(gameName, fieldName, newValue); });
            domRefs.modalContent.querySelectorAll('[data-action="updateVolatility"]').forEach(element => { const { gameName, level } = element.dataset; element.onclick = async () => await updateVolatility(gameName, level); });
            domRefs.modalContent.querySelectorAll('.delete-game-btn').forEach(btn => { btn.onclick = () => promptForGameDeletion(btn.dataset.gameName); });
            domRefs.modalContent.querySelectorAll('[data-action="changeImage"]').forEach(element => { element.onclick = () => promptForImageChange(element.dataset.gameName); });
        };
        
        const createEventCardHTML = (event) => {
            const statusHTML = (platform, platformColor, fieldLabel, dbField, fieldValue) => {
                const isPositive = (fieldValue || '').toLowerCase() === 'sim' || (fieldValue || '').toLowerCase() === 's';
                const newValue = (dbField.includes('destaque')) ? (isPositive ? 'N' : 'S') : (isPositive ? 'N√£o' : 'Sim');
                const icon = isPositive ? '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />' : '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />';
                return `<div class="flex items-center gap-2 cursor-pointer ${isPositive ? 'text-green-400' : 'text-red-400'}" data-action="updateField" data-game-name="${event.game}" data-field-name="${dbField}" data-new-value="${newValue}"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">${icon}</svg><span class="text-sm">${fieldLabel} <span class="${platformColor} font-bold">${platform}</span>: <strong>${fieldValue || 'N/A'}</strong></span></div>`;
            };

            const volatilityMeter = createVolatilityMeterHTML(event.volatility, event.game);
            const hasHighlight = (event.h2bet_destaque && event.h2bet_destaque.toLowerCase() === 's') || (event.seubet_destaque && event.seubet_destaque.toLowerCase() === 's');
            
            let cardClasses = `bg-gray-700 p-4 rounded-lg flex flex-col md:flex-row gap-4 relative group ${hasHighlight ? 'card-highlight' : ''}`;

            const isAdmin = auth.currentUser;
            const imageContainerAttributes = isAdmin ? `data-action="changeImage" data-game-name="${event.game}" title="Clique para alterar a imagem"` : '';
            const imageContainerClasses = `w-full md:w-48 h-48 flex-shrink-0 flex items-center justify-center relative ${isAdmin ? 'cursor-pointer group/image' : ''}`;
            const imageOverlay = isAdmin ? `<div class="absolute inset-0 bg-black bg-opacity-0 group-hover/image:bg-opacity-60 flex items-center justify-center transition-opacity duration-300"><p class="text-white font-bold text-lg opacity-0 group-hover/image:opacity-100">Trocar Imagem</p></div>` : '';

            return `<div class="${cardClasses}">
                        <div class="${imageContainerClasses}" ${imageContainerAttributes}>
                            <img src="${event.gameImage}" alt="${event.game}" class="max-w-full max-h-full object-contain rounded-md" onerror="this.onerror=null;this.src='${PLACEHOLDER_IMAGE}';">
                            ${imageOverlay}
                        </div>
                        <div class="flex-1 flex flex-col">
                            <div>
                                <h4 class="text-xl font-bold text-white">${event.game}</h4>
                                <p class="text-sm bg-indigo-500 inline-block px-2 py-0.5 rounded-full my-2">${event.gameType}</p>
                            </div>
                            <div class="flex-grow grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 mt-2">
                                <div class="space-y-2 border-r border-gray-600 pr-4">
                                    ${statusHTML('H2Bet', 'text-indigo-300', 'Ativo', 'h2bet_ativo', event.h2bet_ativo)}
                                    ${statusHTML('H2Bet', 'text-indigo-300', 'Certificado', 'h2bet_certificado', event.h2bet_certificado)}
                                    ${statusHTML('H2Bet', 'text-indigo-300', 'Destaque', 'h2bet_destaque', event.h2bet_destaque)}
                                </div>
                                <div class="space-y-2">
                                    ${statusHTML('SeuBet', 'text-green-300', 'Ativo', 'seubet_ativo', event.seubet_ativo)}
                                    ${statusHTML('SeuBet', 'text-green-300', 'Certificado', 'seubet_certificado', event.seubet_certificado)}
                                    ${statusHTML('SeuBet', 'text-green-300', 'Destaque', 'seubet_destaque', event.seubet_destaque)}
                                </div>
                            </div>
                            <div class="mt-4">${volatilityMeter}</div>
                            <div class="flex items-center gap-2 mt-3 pt-3 border-t border-gray-600">
                                <img src="${event.providerImage}" alt="${event.provider}" class="h-10 object-contain bg-gray-800 p-1 rounded" onerror="this.onerror=null;this.src='${PLACEHOLDER_PROVIDER_IMAGE}';">
                                <span class="text-gray-300 font-semibold">${event.provider}</span>
                            </div>
                        </div>
                        <button class="delete-game-btn absolute top-2 right-2 p-2 bg-red-600 rounded-full opacity-0 group-hover:opacity-100 transition-opacity" data-game-name="${event.game}" title="Remover Jogo"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                    </div>`;
        };

            const updateGameImage = async (gameName, newImageUrl) => {
                if (!auth.currentUser) return showToast('Voc√™ precisa estar logado para fazer isso.', 'error');
                if (!newImageUrl || !newImageUrl.startsWith('http')) return showToast('URL da imagem inv√°lida.', 'error');

                try {
                    const batch = db.batch();
                    const updateData = { 'Imagem': newImageUrl };
                    batch.set(db.collection('jogos').doc(gameName), updateData, { merge: true });
                    batch.set(db.collection('jogosseubet').doc(gameName), updateData, { merge: true });
                    await batch.commit();
                    showToast(`Imagem de '${gameName}' atualizada!`, 'success');
                    await fetchData();
                } catch (error) { showToast(`Erro ao atualizar imagem: ${error.message}`, 'error'); }
            };

            const promptForImageChange = (gameName) => {
                const newUrl = prompt(`Por favor, insira a nova URL da imagem para o jogo "${gameName}":`);
                if (newUrl) updateGameImage(gameName, newUrl.trim());
            };

            const openAddGameModal = () => {
                editMode = { active: false, originalId: null };
                domRefs.addGameForm.reset();
                domRefs.addGameForm.querySelector('h3').textContent = 'Adicionar Novo Lan√ßamento';
                domRefs.addGameForm.querySelector('button[type="submit"]').textContent = 'Salvar Jogo';
                populateProviderDropdown();
                renderAddVolatilityMeter();
                domRefs.addGameModal.classList.remove('hidden');
            };

            const closeAddGameModal = () => domRefs.addGameModal.classList.add('hidden');
            
            const populateProviderDropdown = () => {
                const select = domRefs.addGameForm.querySelector('[name="provedor"]');
                select.innerHTML = '<option value="">Selecione um provedor</option>';
                providerData.forEach(p => { const o = document.createElement('option'); o.value = o.textContent = p.name; select.appendChild(o); });
                select.insertAdjacentHTML('beforeend', '<option value="__add_new__" class="text-indigo-300 font-bold mt-2 pt-2 border-t border-gray-600">+ Novo Provedor</option>');
            };
            
            const renderAddVolatilityMeter = (selectedLevel = '') => {
                 const levels = { baixo: 'Baixa', medio: 'M√©dia', alto: 'Alta', 'muito alto': 'Muito Alta' };
                 domRefs.addVolatilityMeter.innerHTML = Object.keys(levels).map(key => `<div class="h-full rounded cursor-pointer ${key === selectedLevel ? {baixo:'bg-green-500',medio:'bg-yellow-500',alto:'bg-orange-500','muito alto':'bg-red-500'}[key] : 'bg-gray-600 hover:bg-gray-500'}" data-level="${key}" title="${levels[key]}"></div>`).join('');
                 domRefs.addGameForm.querySelector('[name="volatilidade"]').value = selectedLevel;
                 domRefs.addVolatilityMeter.querySelectorAll('[data-level]').forEach(bar => bar.onclick = () => renderAddVolatilityMeter(domRefs.addGameForm.querySelector('[name="volatilidade"]').value === bar.dataset.level ? '' : bar.dataset.level));
            };
            
            const handleAddProviderSubmit = async (e) => {
                e.preventDefault(); if (!auth.currentUser) return showToast('Voc√™ precisa estar logado.', 'error');
                const providerName = domRefs.addProviderForm['provider-name'].value.trim(), providerLogo = domRefs.addProviderForm['provider-logo'].value.trim();
                if (!providerName || !providerLogo) return showToast('Nome e URL s√£o obrigat√≥rios.', 'error');
                try {
                    await db.collection('provedores').doc(providerName).set({ nome: providerName, logoUrl: providerLogo });
                    showToast('Provedor salvo!', 'success'); domRefs.addProviderModal.classList.add('hidden');
                    await fetchData();
                    const providerSelect = domRefs.addGameForm.querySelector('[name="provedor"]');
                    providerSelect.value = providerName; providerSelect.dispatchEvent(new Event('change'));
                } catch (error) { showToast(`Erro: ${error.message}`, 'error'); }
            };

            const updateSheetField = async (gameName, fieldName, newValue) => {
                if (!auth.currentUser) return showToast('Voc√™ precisa estar logado.', 'error');
                const [platform, field] = fieldName.split('_'); 
                const realFieldName = { ativo: 'Ativo no site?', certificado: 'Certificado', destaque: 'Destaque' }[field];
                const collectionName = platform === 'h2bet' ? 'jogos' : 'jogosseubet';
                try {
                    const docRef = db.collection(collectionName).doc(gameName);
                    const docSnap = await docRef.get();
                    const oldValue = docSnap.exists ? docSnap.data()[realFieldName] : 'N√£o';

                    const batch = db.batch();
                    const updateData = {}; updateData[realFieldName] = newValue; batch.update(docRef, updateData);
                    
                    const normOld = (oldValue || 'N√£o').toLowerCase().trim();
                    const normNew = (newValue || '').toLowerCase().trim();

                    if (realFieldName === 'Certificado' && normOld !== normNew) {
                        const historyRef = db.collection('historico_certificados').doc();
                        batch.set(historyRef, {
                            gameName: gameName,
                            platform: platform === 'h2bet' ? 'H2Bet' : 'SeuBet',
                            oldValue: oldValue || 'N√£o',
                            newValue: newValue,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }

                    await batch.commit();

                    const eventoNaMemoria = events.find(e => e.game === gameName);
                    if (eventoNaMemoria) {
                        eventoNaMemoria[fieldName] = newValue;
                    }

                    showToast(`'${gameName}' atualizado!`, 'success');
                    await fetchData();
                } catch (error) { console.error("Erro:", error); showToast(`Erro: ${error.message}`, 'error'); }
            };  

            const updateVolatility = async (gameName, newLevel) => {
                if (!auth.currentUser) return showToast('Voc√™ precisa estar logado.', 'error');
                const event = events.find(e => e.game === gameName);
                const currentVolatility = event?.volatility || '';
                const finalLevel = (newLevel || '').toLowerCase() === (currentVolatility || '').toLowerCase() ? '' : newLevel;
                try {
                    const batch = db.batch(); const updateData = { 'Volatilidade': finalLevel };
                    batch.update(db.collection('jogos').doc(gameName), updateData);
                    batch.update(db.collection('jogosseubet').doc(gameName), updateData);
                    await batch.commit();
                    showToast(`Volatilidade de '${gameName}' atualizada!`, 'success');
                    await fetchData();
                } catch (error) { showToast(`Erro: ${error.message}`, 'error'); }
            };

            const deleteGameInSheet = async (gameName) => {
                if (!auth.currentUser) return showToast('Voc√™ precisa estar logado.', 'error');
                try {
                    const batch = db.batch();
                    batch.delete(db.collection('jogos').doc(gameName)); batch.delete(db.collection('jogosseubet').doc(gameName));
                    await batch.commit();
                    showToast(`"${gameName}" foi exclu√≠do.`, 'success');
                    closeModal(); await fetchData();
                } catch (error) { showToast(`Erro: ${error.message}`, 'error'); }
            };

            const promptForGameDeletion = (gameName) => { if (confirm(`Tem certeza que deseja remover "${gameName}" de AMBAS as plataformas?`)) { deleteGameInSheet(gameName); } };
            
            const handleAddGameSubmit = async (e) => {
                e.preventDefault(); if (!auth.currentUser) return showToast('Voc√™ precisa estar logado.', 'error');
                const formData = new FormData(domRefs.addGameForm);
                const jogoNome = formData.get('jogo').trim();
                const dataInput = formData.get('data');

                if (!jogoNome || !dataInput) return showToast('Nome e data s√£o obrigat√≥rios.', 'error');
                const dataCorreta = new Date(dataInput + 'T00:00:00');
                if (isNaN(dataCorreta.getTime())) return showToast('Data inv√°lida.', 'error');
                
                const gameData = { 'Data': dataCorreta, 'Provedor': formData.get('provedor'), 'Jogo': jogoNome, 'Tipo de jogo': formData.get('tipodejogo'), 'Imagem': formData.get('imagem'), 'Imagem provedor': formData.get('imagemprovedor'), 'Volatilidade': formData.get('volatilidade') };
                
                const batch = db.batch();
                
                if (editMode.active && editMode.originalId) {
                    batch.delete(db.collection('jogos').doc(editMode.originalId));
                    batch.delete(db.collection('jogosseubet').doc(editMode.originalId));
                }
                
                batch.set(db.collection('jogos').doc(jogoNome), { ...gameData, 'Ativo no site?': formData.get('h2bet_ativo'), 'Certificado': formData.get('h2bet_certificado'), 'Destaque': formData.get('h2bet_destaque') });
                batch.set(db.collection('jogosseubet').doc(jogoNome), { ...gameData, 'Ativo no site?': formData.get('seubet_ativo'), 'Certificado': formData.get('seubet_certificado'), 'Destaque': formData.get('seubet_destaque') });
                
                try {
                    showToast(editMode.active ? 'Ajustando jogo...' : 'Salvando novo jogo...', 'success');
                    await batch.commit();
                    showToast(editMode.active ? 'Jogo ajustado!' : 'Jogo salvo!', 'success');
                    closeAddGameModal();
                    await fetchData();
                } catch (error) { showToast(`Erro: ${error.message}`, 'error'); }
            };
            
            const updateFilterLabel = () => {
                if (selectedProviders.length === 0 || selectedProviders.includes('All')) domRefs.filterLabel.textContent = 'Todos os Provedores';
                else if (selectedProviders.length === 1) domRefs.filterLabel.textContent = selectedProviders[0];
                else domRefs.filterLabel.textContent = `${selectedProviders.length} provedores selecionados`;
            };
            
            const handleProviderToggle = (provider) => {
                if (provider === 'All') selectedProviders = ['All'];
                else { let newSelection = selectedProviders.filter(p => p !== 'All'); if (newSelection.includes(provider)) newSelection = newSelection.filter(p => p !== provider); else newSelection.push(provider); selectedProviders = newSelection.length === 0 ? ['All'] : newSelection; }
                renderFilters(); renderCalendars();
            };
            
            const handleSearchInput = (e) => {
                searchQuery = e.target.value; const suggestions = getFilteredEvents().slice(0, 5);
                if (searchQuery && suggestions.length > 0) { domRefs.autocompleteList.innerHTML = suggestions.map(event => `<div class="p-2 hover:bg-indigo-600 cursor-pointer" data-game="${event.game}">${event.game}</div>`).join(''); domRefs.autocompleteList.classList.remove('hidden'); } else { domRefs.autocompleteList.classList.add('hidden'); }
                renderCalendars();
            };
            
            const renderCarousel = () => {
                if (carouselInterval) clearInterval(carouselInterval);
                const getUniqueCarouselEvents = () => {
                    const today = new Date(); today.setHours(0, 0, 0, 0); const twoDaysAgo = new Date(today); twoDaysAgo.setDate(today.getDate() - 2);
                    const highlightEvents = events.filter(event => !event.hasError && ((event.h2bet_destaque && event.h2bet_destaque.toLowerCase() === 's') || (event.seubet_destaque && event.seubet_destaque.toLowerCase() === 's')) && event.date >= twoDaysAgo).sort((a, b) => a.date - b.date);
                    const uniqueGames = new Map(); for (const event of highlightEvents) { if (!uniqueGames.has(event.game)) { uniqueGames.set(event.game, event); } } return Array.from(uniqueGames.values());
                };
                const carouselEvents = getUniqueCarouselEvents();
                if (carouselEvents.length === 0) { domRefs.carouselWrapper.innerHTML = '<div class="text-center w-full text-gray-400 p-8">Nenhum jogo em destaque.</div>'; return; }
                const getVisibleSlidesCount = () => { if (window.innerWidth <= 640) return 1; if (window.innerWidth <= 1024) return 2; return 3; }; const numVisibleSlides = getVisibleSlidesCount(); const enableInfiniteScroll = carouselEvents.length > numVisibleSlides; let slides = carouselEvents; if (enableInfiniteScroll) { slides = [...carouselEvents, ...carouselEvents.slice(0, numVisibleSlides)]; }
                domRefs.carouselWrapper.innerHTML = slides.map(event => `<div class="carousel-slide" data-gamedate="${event.date.toISOString()}"><img src="${event.gameImage}" alt="${event.game}" onerror="this.onerror=null;this.src='${PLACEHOLDER_IMAGE}';"><div class="slide-title">${event.game}</div></div>`).join('');
                if (enableInfiniteScroll) { let currentIndex = 0; const totalUniqueSlides = carouselEvents.length; const advanceCarousel = () => { if (domRefs.carouselWrapper.children.length === 0) return; const slideWidth = domRefs.carouselWrapper.children[0].getBoundingClientRect().width; if (slideWidth === 0) return; currentIndex++; domRefs.carouselWrapper.style.transition = 'transform 0.5s ease-in-out'; domRefs.carouselWrapper.style.transform = `translateX(-${currentIndex * slideWidth}px)`; if (currentIndex >= totalUniqueSlides) { setTimeout(() => { domRefs.carouselWrapper.style.transition = 'none'; currentIndex = 0; domRefs.carouselWrapper.style.transform = `translateX(0)`; }, 500); } }; if (carouselInterval) clearInterval(carouselInterval); carouselInterval = setInterval(advanceCarousel, 3000); }
            };

            const handleCarouselClick = (e) => {
                const slide = e.target.closest('.carousel-slide');
                if (!slide) return;
                const eventDate = new Date(slide.dataset.gamedate);
                currentDate = new Date(eventDate.getFullYear(), eventDate.getMonth(), 1);
                renderCalendars();
                const dayEvents = events.filter(ev => ev.date && ev.date.toDateString() === eventDate.toDateString());
                if (dayEvents.length > 0) renderModal(eventDate, dayEvents);
            };

            const startDragging = (e) => {
                isDown = true; hasDragged = false; domRefs.carouselContainer.classList.add('grabbing');
                startX = e.pageX || e.touches[0].pageX - domRefs.carouselContainer.offsetLeft;
                scrollLeft = domRefs.carouselContainer.scrollLeft;
                if (carouselInterval) clearInterval(carouselInterval);
            };
            const stopDragging = () => { isDown = false; domRefs.carouselContainer.classList.remove('grabbing');};
            const whileDragging = (e) => {
                if (!isDown) return; e.preventDefault(); hasDragged = true;
                const x = e.pageX || e.touches[0].pageX - domRefs.carouselContainer.offsetLeft;
                domRefs.carouselContainer.scrollLeft = scrollLeft - ((x - startX) * 2);
            };

            const renderParticles = () => {
                for (let i = 0; i < 50; i++) { const p = document.createElement('div'); p.className = 'particle'; const s = Math.random() * 4 + 1; p.style.width = `${s}px`; p.style.height = `${s}px`; p.style.left = `${Math.random() * 100}%`; p.style.top = `${Math.random() * 100}%`; p.style.animationDuration = `${Math.random() * 20 + 10}s`; p.style.animationDelay = `${Math.random() * -30}s`; domRefs.particlesContainer.appendChild(p); }
            };

            // --- L√ìGICA DE EXTRA√á√ÉO EXCEL ---
            const getAvailableMonths = () => {
                const uniqueMonths = new Set();
                events.forEach(e => {
                    if (e.date) { uniqueMonths.add(`${e.date.getFullYear()}-${String(e.date.getMonth() + 1).padStart(2, '0')}`); }
                });
                return Array.from(uniqueMonths).sort().reverse();
            };

            const populateMonthCheckboxes = () => {
                const months = getAvailableMonths();
                extractionRefs.grid.innerHTML = '';
                if (months.length === 0) { extractionRefs.grid.innerHTML = '<span class="text-xs text-gray-500 col-span-2">Nenhum dado encontrado.</span>'; return; }
                months.forEach(monthStr => {
                    const [year, month] = monthStr.split('-');
                    extractionRefs.grid.insertAdjacentHTML('beforeend', `
                        <div class="flex items-center gap-2">
                            <input type="checkbox" value="${monthStr}" class="month-checkbox w-4 h-4 text-purple-600 bg-gray-700 border-gray-600 rounded">
                            <label class="text-sm text-gray-300">${monthNames[parseInt(month) - 1]} ${year}</label>
                        </div>
                    `);
                });
            };

            const openExtractionModal = () => {
                domRefs.extractionMonthInput.value = new Date().toISOString().slice(0, 7);
                extractionRefs.toggle.checked = false; extractionRefs.selectAll.checked = false;
                toggleExtractionMode(); populateMonthCheckboxes();
                domRefs.extractionModal.classList.remove('hidden');
            };

            const toggleExtractionMode = () => {
                if (extractionRefs.toggle.checked) {
                    extractionRefs.singleContainer.classList.add('hidden'); extractionRefs.multiContainer.classList.remove('hidden');
                } else {
                    extractionRefs.singleContainer.classList.remove('hidden'); extractionRefs.multiContainer.classList.add('hidden');
                }
            };

            const handleSelectAllMonths = () => {
                const isChecked = extractionRefs.selectAll.checked;
                extractionRefs.grid.querySelectorAll('.month-checkbox').forEach(cb => cb.checked = isChecked);
            };

            const closeExtractionModal = () => domRefs.extractionModal.classList.add('hidden');

            const generateExcel = () => {
                let targetMonths = [], fileNameLabel = "";
                if (extractionRefs.toggle.checked) {
                    const checkedBoxes = extractionRefs.grid.querySelectorAll('.month-checkbox:checked');
                    if (checkedBoxes.length === 0) return showToast('Selecione pelo menos um m√™s!', 'error');
                    checkedBoxes.forEach(cb => targetMonths.push(cb.value));
                    fileNameLabel = "Multiplos_Meses";
                } else {
                    const selectedValue = domRefs.extractionMonthInput.value;
                    if (!selectedValue) return showToast('Selecione um m√™s!', 'error');
                    targetMonths.push(selectedValue);
                    fileNameLabel = selectedValue;
                }

                const filteredEvents = events.filter(e => {
                    if (!e.date) return false;
                    return targetMonths.includes(`${e.date.getFullYear()}-${String(e.date.getMonth() + 1).padStart(2, '0')}`);
                });

                if (filteredEvents.length === 0) return showToast('Nenhum jogo encontrado.', 'error');

                const excelData = filteredEvents.map(e => ({
                    "Data": e.date.toLocaleDateString('pt-BR'),
                    "Dia da Semana": weekDays[e.date.getDay()],
                    "Jogo": e.game,
                    "Provedor": e.provider,
                    "Tipo de Jogo": e.gameType,
                    "Volatilidade": e.volatility,
                    "H2Bet - Ativo": e.h2bet_ativo,
                    "H2Bet - Certificado": e.h2bet_certificado,
                    "H2Bet - Destaque": e.h2bet_destaque,
                    "SeuBet - Ativo": e.seubet_ativo,
                    "SeuBet - Certificado": e.seubet_certificado,
                    "SeuBet - Destaque": e.seubet_destaque,
                    "Imagem URL": e.gameImage
                })).sort((a, b) => new Date(a.Data.split('/').reverse().join('-')) - new Date(b.Data.split('/').reverse().join('-')));

                const worksheet = XLSX.utils.json_to_sheet(excelData);
                worksheet['!cols'] = [{wch: 12}, {wch: 8}, {wch: 30}, {wch: 20}, {wch: 15}, {wch: 15}, {wch: 10}, {wch: 10}, {wch: 10}, {wch: 10}, {wch: 10}, {wch: 10}, {wch: 50}];
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Lan√ßamentos");

                const fileName = `Lancamentos_${fileNameLabel}.xlsx`;
                XLSX.writeFile(workbook, fileName);
                showToast(`Download iniciado: ${fileName}`, 'success');
                closeExtractionModal();
            };

            // --- EVENT LISTENERS ---
            domRefs.addGameBtn.onclick = openAddGameModal;
            domRefs.cancelAddGameBtn.onclick = closeAddGameModal;
            domRefs.addGameForm.onsubmit = handleAddGameSubmit;
            const providerSelect = domRefs.addGameForm.querySelector('[name="provedor"]');
            providerSelect.addEventListener('change', (e) => { if (providerSelect.value === '__add_new__') { domRefs.addProviderModal.classList.remove('hidden'); providerSelect.value = ''; } else { const p = providerData.find(p => p.name === e.target.value); domRefs.addGameForm.querySelector('[name="imagemprovedor"]').value = p ? p.link : ''; } });
            domRefs.cancelAddProviderBtn.onclick = () => domRefs.addProviderModal.classList.add('hidden');
            domRefs.addProviderForm.onsubmit = handleAddProviderSubmit;
            domRefs.prevBtn.onclick = () => { currentDate.setMonth(currentDate.getMonth() - 2); renderCalendars(); };
            domRefs.nextBtn.onclick = () => { currentDate.setMonth(currentDate.getMonth() + 2); renderCalendars(); };
            domRefs.todayBtn.onclick = () => { currentDate = new Date(); renderCalendars(); };
            domRefs.modal.onclick = (e) => { if (e.target === domRefs.modal) closeModal(); };
            domRefs.searchInput.oninput = handleSearchInput;
            domRefs.autocompleteList.onclick = (e) => { if (e.target.dataset.game) { const selectedGame = e.target.dataset.game; domRefs.searchInput.value = searchQuery = selectedGame; domRefs.autocompleteList.classList.add('hidden'); const event = events.find(ev => ev.game === selectedGame); if (event) { currentDate = new Date(event.date.getFullYear(), event.date.getMonth(), 1); } renderCalendars(); } };
            domRefs.toggleFilterBtn.onclick = () => { domRefs.filterOptions.classList.toggle('hidden'); domRefs.filterChevron.classList.toggle('rotate-180'); };
            domRefs.loginBtn.onclick = () => domRefs.loginModal.classList.remove('hidden');
            domRefs.cancelLoginBtn.onclick = () => domRefs.loginModal.classList.add('hidden');
            domRefs.logoutBtn.onclick = () => { auth.signOut(); showToast('Voc√™ foi desconectado.', 'success'); };
            domRefs.loginForm.onsubmit = async (e) => { e.preventDefault(); const { email, password } = domRefs.loginForm; try { await auth.signInWithEmailAndPassword(email.value, password.value); domRefs.loginModal.classList.add('hidden'); showToast('Login efetuado com sucesso!', 'success'); } catch (error) { showToast(`Erro: ${error.message}`, 'error'); } };
            
            domRefs.extractionBtn.onclick = openExtractionModal;
            domRefs.cancelExtractionBtn.onclick = closeExtractionModal;
            domRefs.confirmExtractionBtn.onclick = generateExcel;
            domRefs.extractionModal.onclick = (e) => { if (e.target === domRefs.extractionModal) closeExtractionModal(); };
            extractionRefs.toggle.onchange = toggleExtractionMode;
            extractionRefs.selectAll.onchange = handleSelectAllMonths;

            domRefs.carouselContainer.addEventListener('mousedown', startDragging);
            domRefs.carouselContainer.addEventListener('mouseleave', stopDragging);
            domRefs.carouselContainer.addEventListener('mouseup', stopDragging);
            domRefs.carouselContainer.addEventListener('mousemove', whileDragging);
            domRefs.carouselContainer.addEventListener('touchstart', startDragging, { passive: true });
            domRefs.carouselContainer.addEventListener('touchend', stopDragging);
            domRefs.carouselContainer.addEventListener('touchmove', whileDragging);
            domRefs.carouselContainer.addEventListener('click', (e) => { if (hasDragged) { e.stopPropagation(); e.preventDefault(); } else { handleCarouselClick(e); } }, true);

            window.addEventListener('resize', renderCarousel);
            document.onclick = (e) => { if (!e.target.closest('.relative')) domRefs.autocompleteList.classList.add('hidden'); if (!domRefs.toggleFilterBtn.contains(e.target) && !domRefs.filterOptions.contains(e.target)) { domRefs.filterOptions.classList.add('hidden'); domRefs.filterChevron.classList.remove('rotate-180'); } };

            // --- L√ìGICA PARA LIMPAR O HIST√ìRICO (ALT + SHIFT + K) ---
            const clearCertificateHistory = async () => {
                if (!auth.currentUser) {
                    return showToast('Voc√™ precisa estar logado como administrador.', 'error');
                }

                // Dispara o popup nativo de confirma√ß√£o do navegador
                const confirmacao = confirm('Excluir hist√≥rico: Tem certeza que deseja apagar todo o hist√≥rico de certificados? Esta a√ß√£o n√£o pode ser desfeita.');
                
                if (confirmacao) {
                    try {
                        showToast('Limpando hist√≥rico...', 'success');
                        
                        // Busca todos os documentos da cole√ß√£o de hist√≥rico
                        const snapshot = await db.collection('historico_certificados').get();
                        
                        if (snapshot.empty) {
                            return showToast('O hist√≥rico j√° est√° vazio.', 'success');
                        }

                        // Cria um lote (batch) para deletar todos de uma vez
                        const batch = db.batch();
                        snapshot.forEach(doc => {
                            batch.delete(doc.ref);
                        });

                        await batch.commit();
                        showToast('Hist√≥rico exclu√≠do com sucesso!', 'success');
                    } catch (error) {
                        console.error("Erro ao limpar hist√≥rico:", error);
                        showToast(`Erro: ${error.message}`, 'error');
                    }
                }
            };

            // Ouvinte de teclado para o atalho
            document.addEventListener('keydown', (e) => {
                // e.key.toLowerCase() garante que funcione com ou sem CapsLock ativado
                if (e.altKey && e.shiftKey && e.key.toLowerCase() === 'k') {
                    e.preventDefault(); // Evita que o navegador fa√ßa alguma a√ß√£o padr√£o do atalho
                    clearCertificateHistory();
                }
            });
            // --- FIM DA L√ìGICA DE LIMPAR HIST√ìRICO ---

            renderParticles(); fetchData();
        });
    </script>
</body>
</html>